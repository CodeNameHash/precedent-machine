<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Precedent Machine</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,wght@0,400;0,600;0,700;1,400&family=Source+Sans+3:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#FAFAF8;--bg2:#fff;--bg3:#FAF8F5;--bg4:#F5F3EE;
  --border:#E8E6E1;--border2:#DDD;
  --text:#1a1a1a;--text2:#444;--text3:#888;--text4:#aaa;--text5:#ccc;
  --gold:#B8956A;--gold-light:#FAF6F0;--gold-border:rgba(184,149,106,0.25);
  --green:#2E7D32;--green-bg:#E8F5E9;--yellow:#F57F17;--yellow-bg:#FFF8E1;
  --red:#C62828;--red-bg:#FFEBEE;--blue:#1565C0;--blue-bg:#E3F2FD;
  --sans:'Source Sans 3',sans-serif;--serif:'Source Serif 4',serif;--mono:'JetBrains Mono',monospace;
}
body{font-family:var(--sans);background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
::selection{background:rgba(184,149,106,0.2)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#ddd;border-radius:3px}
button{font-family:var(--sans);cursor:pointer}input,textarea,select{font-family:var(--sans)}
textarea::placeholder,input::placeholder{color:#bbb}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.spinner{animation:spin 1s linear infinite}

#app{display:flex;flex-direction:column;height:100vh}
.header{padding:12px 28px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.search-section{padding:16px 28px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.main{flex:1;display:flex;overflow:hidden}
.sidebar{width:300px;border-right:1px solid var(--border);background:var(--bg2);overflow-y:auto;flex-shrink:0}
.content{flex:1;overflow-y:auto;background:var(--bg)}

.logo{display:flex;align-items:center;gap:10px}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--gold)}
.logo h1{font:600 17px var(--serif);color:var(--text);letter-spacing:-0.3px}
.nav{display:flex;gap:6px}
.nav-btn{padding:6px 14px;border-radius:6px;border:1px solid var(--border2);background:var(--bg2);color:var(--text3);font-size:12px;font-weight:500;display:flex;align-items:center;gap:5px}
.nav-btn:hover{border-color:var(--gold);color:var(--gold)}
.nav-btn.active{background:var(--text);color:#fff;border-color:var(--text)}

.search-row{display:flex;gap:8px;margin-bottom:10px}
.search-wrap{flex:1;display:flex;align-items:center;gap:8px;padding:0 14px;border-radius:8px;background:var(--bg);border:1px solid var(--border2)}
.search-wrap:focus-within{border-color:var(--gold)}
.search-wrap input{flex:1;padding:10px 0;background:none;border:none;color:var(--text);font-size:13.5px;outline:none}
.search-wrap svg{color:var(--text4);flex-shrink:0}
.search-btn{padding:10px 20px;border-radius:8px;background:var(--text);color:#fff;border:none;font-size:12px;font-weight:600}
.search-btn:disabled{background:#ccc}
.filters-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;min-height:28px}
.filter-chip{padding:5px 11px;border-radius:6px;border:1px solid var(--border2);background:var(--bg2);color:var(--text3);font-size:11.5px;cursor:pointer}
.filter-chip:hover{border-color:var(--gold);color:var(--gold)}
.filter-label{font-size:10px;color:var(--text4);text-transform:uppercase;letter-spacing:1px}

.sidebar-header{padding:12px 16px;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text4);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.deal-item{padding:10px 16px;border-bottom:1px solid #F0EEEA;cursor:pointer;display:flex;align-items:flex-start;gap:10px;transition:background 0.1s}
.deal-item:hover{background:var(--bg)}
.deal-check{width:16px;height:16px;border:1.5px solid #ccc;border-radius:3px;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;transition:all 0.1s}
.deal-check.checked{background:var(--gold);border-color:var(--gold)}
.deal-info{flex:1;min-width:0}
.deal-name{font:600 12.5px var(--serif);color:var(--text);line-height:1.3}
.deal-meta{font-size:10.5px;color:var(--text3);margin-top:1px}

.prov-item{padding:10px 16px;border-bottom:1px solid #F0EEEA;cursor:pointer}
.prov-item:hover{background:var(--bg)}
.prov-item.selected{background:var(--gold-light);border-left:3px solid var(--gold)}
.prov-type{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--gold);font-weight:600;margin-bottom:2px}
.prov-title{font:600 12px var(--serif);color:var(--text);margin-bottom:2px}
.prov-deal{font-size:11px;color:var(--text3)}

.content-header{padding:20px 28px;border-bottom:1px solid var(--border);background:var(--bg2)}
.provision-type-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--gold);margin-bottom:4px;font-weight:600}
.content-title{font:700 22px var(--serif);color:var(--text);margin-bottom:6px;line-height:1.2}
.content-subtitle{font-size:13px;color:var(--text3);line-height:1.5}
.view-tabs{display:flex;gap:0;margin-top:14px;border-bottom:1px solid var(--border)}
.view-tab{padding:8px 16px;font-size:12px;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px}
.view-tab:hover{color:var(--text)}
.view-tab.active{color:var(--text);border-bottom-color:var(--gold)}
.action-row{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
.action-btn{display:flex;align-items:center;gap:5px;padding:7px 14px;border-radius:6px;border:1px solid var(--border2);background:var(--bg2);color:var(--text2);font-size:12px}
.action-btn:hover{border-color:var(--gold);color:var(--gold)}
.action-btn.primary{background:var(--text);color:#fff;border-color:var(--text)}.action-btn.primary:hover{background:#333}
.action-btn.compare{background:var(--gold);color:#fff;border-color:var(--gold)}.action-btn.compare:hover{background:#a17e52}

.prongs-section{padding:20px 28px}
.prong-card{margin-bottom:16px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--bg2)}
.prong-header{padding:10px 16px;background:var(--bg3);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;cursor:pointer;user-select:none}
.prong-header:hover{background:var(--bg4)}
.prong-name{font:600 13px var(--serif);color:var(--text)}
.prong-tag{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:500}
.prong-tag.all{background:var(--green-bg);color:var(--green)}
.prong-tag.varies{background:var(--yellow-bg);color:var(--yellow)}
.prong-tag.missing{background:var(--red-bg);color:var(--red)}
.admin-edit{font-size:11px;color:var(--gold);cursor:pointer;opacity:0.5;background:none;border:none}
.admin-edit:hover{opacity:1;text-decoration:underline}
.prong-body{display:grid}
.prong-body.collapsed{display:none}
.prong-cell{padding:12px 16px;border-right:1px solid #F0EEEA}
.prong-cell:last-child{border-right:none}
.prong-deal-label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--gold);margin-bottom:5px;font-weight:600}
.prong-text{font:400 12px/1.65 var(--serif);color:var(--text2)}
.prong-text .hl{background:#FFF9C4;padding:0 2px;border-radius:2px}
.prong-text .absent{color:var(--text5);font-style:italic}
.prong-text .pct-ann{color:var(--gold);font-weight:600;font-size:10px;font-family:var(--sans)}
.collapse-arrow{display:inline-block;transition:transform 0.2s;font-size:10px;color:var(--text4);margin-right:6px}
.collapse-arrow.open{transform:rotate(90deg)}

/* IOC exception nesting */
.ioc-exception-section{margin-top:8px;padding-top:8px;border-top:1px dashed var(--border)}
.ioc-exception-label{font-size:9px;text-transform:uppercase;letter-spacing:0.8px;color:var(--blue);font-weight:600;margin-bottom:3px}
.ioc-exception-text{font:400 11.5px/1.6 var(--serif);color:var(--text2);padding-left:10px;border-left:2px solid var(--blue-bg)}

.fav-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:3px;font-size:9px;font-weight:600;letter-spacing:0.3px;cursor:pointer;user-select:none;white-space:nowrap}
.fav-badge.strong-buyer{background:#E3F2FD;color:#1565C0}
.fav-badge.mod-buyer{background:#E8F0FE;color:#4285f4}
.fav-badge.neutral{background:#F5F5F5;color:#757575}
.fav-badge.mod-seller{background:#FFF3E0;color:#E65100}
.fav-badge.strong-seller{background:#FFEBEE;color:#C62828}
.fav-badge.unrated{background:var(--bg);color:var(--text5);border:1px dashed var(--border2)}

.prong-analysis{padding:10px 16px;background:#FAFAF8;border-top:1px solid var(--border);font-size:12px;line-height:1.6;color:var(--text2);animation:fadeIn 0.3s}
.prong-analysis strong{color:var(--text)}

/* Coverage (admin only) */
.coverage-bar{height:4px;border-radius:2px;background:var(--border);overflow:hidden;margin-top:4px}
.coverage-fill{height:100%;border-radius:2px}.coverage-fill.full{background:var(--green)}.coverage-fill.partial{background:var(--yellow)}.coverage-fill.low{background:var(--red)}

.admin-banner{margin:16px 28px;padding:10px 16px;background:var(--yellow-bg);border:1px solid #FFE082;border-radius:8px;display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--yellow);flex-wrap:wrap;gap:8px}
.admin-banner button{padding:4px 10px;border-radius:5px;border:1px solid #FFB300;background:#fff;color:var(--yellow);font-size:11px}

.full-text-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text4);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.full-text{font:400 13px/1.8 var(--serif);color:var(--text2);padding:16px;background:var(--bg);border-radius:8px;border:1px solid var(--border);white-space:pre-wrap}
.full-text .coded{border-bottom:2px solid var(--gold);cursor:pointer}.full-text .coded:hover{background:var(--gold-light)}

.ask-panel{display:none;flex-direction:column;width:380px;border-left:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.ask-panel.open{display:flex}
.ask-header{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.ask-messages{flex:1;overflow-y:auto;padding:14px}
.ask-msg{margin-bottom:12px;animation:fadeIn 0.2s}.ask-msg.user{text-align:right}
.ask-msg.user .bubble{background:var(--bg);border:1px solid var(--border);display:inline-block;text-align:left}
.ask-msg.assistant .bubble{background:var(--bg3);border:1px solid var(--border)}
.bubble{padding:10px 14px;border-radius:8px;font-size:12.5px;line-height:1.6;max-width:95%}
.ask-input-row{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px}
.ask-input-row textarea{flex:1;padding:8px 12px;border-radius:8px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:12.5px;resize:none;outline:none;min-height:36px;max-height:100px}
.ask-input-row textarea:focus{border-color:var(--gold)}
.ask-send{padding:0 14px;border-radius:8px;background:var(--text);color:#fff;border:none;font-weight:600;font-size:11px}.ask-send:disabled{background:#ccc}

.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:1000;display:flex;justify-content:center;align-items:center;backdrop-filter:blur(2px)}
.modal{width:90%;max-width:750px;max-height:85vh;background:var(--bg2);border-radius:12px;border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;box-shadow:0 16px 48px rgba(0,0,0,0.15)}
.modal-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-body{flex:1;overflow-y:auto;padding:20px}
.close-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px}
.recode-modal .modal{max-width:550px}
.recode-field{margin-bottom:14px}
.recode-field label{display:block;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:4px}
.recode-field select,.recode-field textarea,.recode-field input[type="text"]{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--bg);outline:none}
.recode-field textarea{font-family:var(--serif);min-height:100px;line-height:1.6}
.recode-field select:focus,.recode-field textarea:focus,.recode-field input:focus{border-color:var(--gold)}
.save-btn{padding:8px 20px;border-radius:6px;background:var(--gold);color:#fff;border:none;font-size:13px;font-weight:600}.save-btn:hover{background:#a17e52}

.report-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--bg2);margin-bottom:20px}
.report-table th{padding:10px 14px;font:600 9px var(--sans);text-transform:uppercase;letter-spacing:1px;color:var(--gold);background:var(--bg3);border-bottom:1px solid var(--border);text-align:left;border-right:1px solid var(--border)}
.report-table th:last-child{border-right:none}
.report-table td{padding:10px 14px;font:400 11.5px/1.6 var(--serif);color:var(--text2);border-bottom:1px solid #F0EEEA;border-right:1px solid #F0EEEA;vertical-align:top}
.report-table td:last-child{border-right:none}
.report-table tr:last-child td{border-bottom:none}
.report-table td.lbl{font:600 11.5px var(--sans);color:var(--text);background:var(--bg3);white-space:nowrap}

.fav-dropdown{position:fixed;z-index:1100;background:var(--bg2);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);padding:4px;min-width:160px}
.fav-option{padding:6px 10px;font-size:11px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px}.fav-option:hover{background:var(--bg)}
.fav-dot{width:8px;height:8px;border-radius:50%}

.redline-textarea{width:100%;min-height:140px;padding:14px;border-radius:8px;background:var(--bg);border:1px solid var(--border);color:var(--text2);font:400 13px/1.7 var(--serif);resize:vertical;outline:none}.redline-textarea:focus{border-color:var(--gold)}
.risk-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.risk-badge.low{background:var(--green-bg);color:var(--green)}.risk-badge.medium{background:var(--yellow-bg);color:var(--yellow)}.risk-badge.high{background:var(--red-bg);color:var(--red)}
.diff-card{padding:14px;border-radius:8px;background:var(--bg);border:1px solid var(--border);margin-bottom:10px}
.diff-cols{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
.diff-col label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text4);display:block;margin-bottom:2px}
.diff-col p{font:italic 12px/1.5 var(--serif);color:var(--text3)}
.diff-rec{font-size:12px;color:var(--gold);padding:7px 10px;border-radius:5px;background:var(--gold-light);border-left:3px solid var(--gold);margin-top:8px;line-height:1.5}

.empty{padding:60px 20px;text-align:center;color:var(--text4)}.empty h3{font:600 16px var(--serif);color:var(--text3);margin-bottom:4px}
.loading{display:flex;align-items:center;gap:8px;color:var(--text3);padding:30px;justify-content:center;font-size:13px}
.provision-section-divider{padding:14px 0 6px;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--gold);font-weight:700;border-bottom:2px solid var(--gold-border);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none}
.provision-section-divider:hover{color:#a17e52}
.provision-section-divider .meta{font-size:10px;color:var(--text3);text-transform:none;letter-spacing:0;font-weight:400}
</style>
</head>
<body>
<div id="app">
<div class="header">
  <div class="logo"><div class="logo-dot"></div><h1>Precedent Machine</h1></div>
  <div class="nav"><button class="nav-btn" onclick="toggleAdmin()" id="admin-btn">Admin</button><button class="nav-btn" onclick="toggleAsk()" id="ask-btn">Ask</button></div>
</div>
<div class="search-section">
  <div class="search-row">
    <div class="search-wrap"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input id="q" placeholder="Search provisions or deals..." oninput="onInput()" onkeydown="if(event.key==='Enter')doSearch()"><button onclick="clearQ()" style="background:none;border:none;color:var(--text4);cursor:pointer;display:none" id="q-clear">&#10005;</button></div>
    <button class="search-btn" onclick="doSearch()" id="search-go">Search</button>
  </div>
  <div class="filters-row"><span class="filter-label">Filters:</span><span id="suggested-filters"></span></div>
</div>
<div class="main">
  <div class="sidebar" id="sidebar"></div>
  <div class="content" id="content"><div class="empty"><h3>Select deals to compare</h3><p>Check two or more deals, then optionally filter by provision type</p></div></div>
  <div class="ask-panel" id="ask-panel">
    <div class="ask-header"><span style="font:600 13px var(--serif)">Interrogate Precedents</span><button onclick="toggleAsk()" class="close-btn">&#10005;</button></div>
    <div class="ask-messages" id="ask-msgs"><div class="ask-msg assistant"><div class="bubble">Ask me anything about the precedents.</div></div></div>
    <div class="ask-input-row"><textarea id="ask-q" rows="1" placeholder="Which deals have the broadest MAE carve-outs?" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAsk()}"></textarea><button class="ask-send" onclick="sendAsk()" id="ask-go">Send</button></div>
  </div>
</div>
</div>
<div class="modal-bg recode-modal" id="recode-modal" style="display:none" onclick="if(event.target===this)this.style.display='none'"><div class="modal"><div class="modal-header"><span style="font:600 14px var(--serif)">Recode Sub-Provision</span><button class="close-btn" onclick="document.getElementById('recode-modal').style.display='none'">&#10005;</button></div><div class="modal-body" id="recode-body"></div></div></div>
<div class="modal-bg" id="add-cat-modal" style="display:none" onclick="if(event.target===this)this.style.display='none'"><div class="modal" style="max-width:450px"><div class="modal-header"><span style="font:600 14px var(--serif)">Add Sub-Provision Category</span><button class="close-btn" onclick="document.getElementById('add-cat-modal').style.display='none'">&#10005;</button></div><div class="modal-body" id="add-cat-body"></div></div></div>
<div id="fav-dropdown" class="fav-dropdown" style="display:none"></div>

<script>
// ═══════════════════════════════════════
// DATA
// ═══════════════════════════════════════
const DEALS=[
  {id:"d1",acquirer:"Broadcom Inc.",target:"VMware, Inc.",value:"$61B",valueNum:61e9,sector:"Technology",date:"2022-05-26",jurisdiction:"Delaware",lawyers:{buyer:["Wachtell Lipton"],seller:["Gibson Dunn"]},advisors:{buyer:["Silver Lake"],seller:["Goldman Sachs","J.P. Morgan"]},structure:"Reverse triangular merger",termFee:"$1.5B / $1.5B"},
  {id:"d2",acquirer:"Microsoft",target:"Activision Blizzard",value:"$68.7B",valueNum:68.7e9,sector:"Technology/Gaming",date:"2022-01-18",jurisdiction:"Delaware",lawyers:{buyer:["Simpson Thacher"],seller:["Skadden Arps"]},advisors:{buyer:["Goldman Sachs"],seller:["Allen & Company"]},structure:"Reverse triangular merger",termFee:"$2.5B / $3.0B"},
  {id:"d3",acquirer:"Pfizer",target:"Seagen",value:"$43B",valueNum:43e9,sector:"Biopharma",date:"2023-03-13",jurisdiction:"Delaware",lawyers:{buyer:["Wachtell Lipton"],seller:["Cravath Swaine"]},advisors:{buyer:["Guggenheim"],seller:["Centerview","Goldman Sachs"]},structure:"Reverse triangular merger",termFee:"$1.25B / $2.2B"},
  {id:"d4",acquirer:"Amgen",target:"Horizon Therapeutics",value:"$28.3B",valueNum:28.3e9,sector:"Biopharma",date:"2022-12-12",jurisdiction:"Delaware",lawyers:{buyer:["Sullivan & Cromwell"],seller:["Cooley"]},advisors:{buyer:["Morgan Stanley"],seller:["Goldman Sachs","Centerview"]},structure:"Reverse triangular merger",termFee:"$750M / $1.8B"},
  {id:"d5",acquirer:"Adobe",target:"Figma",value:"$20B",valueNum:20e9,sector:"Technology",date:"2022-09-15",jurisdiction:"Delaware",lawyers:{buyer:["Cravath Swaine"],seller:["Fenwick & West"]},advisors:{buyer:[],seller:["Qatalyst Partners"]},structure:"Merger (terminated)",termFee:"$1B reverse"},
  {id:"d6",acquirer:"X Holdings (Musk)",target:"Twitter",value:"$44B",valueNum:44e9,sector:"Technology",date:"2022-04-25",jurisdiction:"Delaware",lawyers:{buyer:["Skadden Arps"],seller:["Wilson Sonsini"]},advisors:{buyer:["Morgan Stanley"],seller:["Goldman Sachs","J.P. Morgan"]},structure:"Single-step merger",termFee:"$1B each"},
  {id:"d7",acquirer:"Merck",target:"Prometheus Biosciences",value:"$10.8B",valueNum:10.8e9,sector:"Biopharma",date:"2023-04-16",jurisdiction:"Delaware",lawyers:{buyer:["Davis Polk"],seller:["Cooley"]},advisors:{buyer:[],seller:["Goldman Sachs"]},structure:"Reverse triangular merger",termFee:"$350M (Co)"},
  {id:"d8",acquirer:"Cisco",target:"Splunk",value:"$28B",valueNum:28e9,sector:"Technology",date:"2023-09-21",jurisdiction:"Delaware",lawyers:{buyer:["Simpson Thacher"],seller:["Latham & Watkins"]},advisors:{buyer:["Barclays"],seller:["Morgan Stanley","Goldman Sachs"]},structure:"Reverse triangular merger",termFee:"$1.48B / $2.0B"},
  {id:"d9",acquirer:"Exxon Mobil",target:"Pioneer Natural Resources",value:"$59.5B",valueNum:59.5e9,sector:"Energy",date:"2023-10-11",jurisdiction:"Delaware",lawyers:{buyer:["Davis Polk"],seller:["Gibson Dunn"]},advisors:{buyer:[],seller:["Evercore"]},structure:"All-stock merger",termFee:"N/A"},
  {id:"d10",acquirer:"Capital One",target:"Discover Financial",value:"$35.3B",valueNum:35.3e9,sector:"Financial Services",date:"2024-02-19",jurisdiction:"Delaware",lawyers:{buyer:["Wachtell Lipton"],seller:["Sullivan & Cromwell"]},advisors:{buyer:["Centerview"],seller:["Morgan Stanley"]},structure:"Bank merger",termFee:"$1.38B each"},
];

const PROVISION_TYPES=[{key:"MAE",label:"Material Adverse Effect"},{key:"IOC",label:"Interim Operating Covenants"}];
let SUB_PROVISIONS={
  MAE:["Base Definition","General Economic / Market Conditions","Changes in Law / GAAP","Industry Conditions","War / Terrorism","Acts of God / Pandemic","Failure to Meet Projections","Announcement / Pendency Effects","Actions at Parent Request","Disproportionate Impact Qualifier","Changes in Stock Price","Customer / Supplier Relationships"],
  IOC:["M&A / Acquisitions","Dividends / Distributions","Equity Issuances","Indebtedness","Capital Expenditures","Employee Compensation","Material Contracts","Accounting / Tax Changes","Ordinary Course Standard"]
};
const sc=JSON.parse(localStorage.getItem("customSubProvisions")||"null");if(sc)SUB_PROVISIONS=sc;
function saveCats(){localStorage.setItem("customSubProvisions",JSON.stringify(SUB_PROVISIONS))}

const FAV_LEVELS=[{key:"strong-buyer",label:"Strong Buyer",color:"#1565C0"},{key:"mod-buyer",label:"Mod. Buyer",color:"#4285f4"},{key:"neutral",label:"Neutral",color:"#757575"},{key:"mod-seller",label:"Mod. Seller",color:"#E65100"},{key:"strong-seller",label:"Strong Seller",color:"#C62828"}];

// ─── MAE PROVISIONS (flat: one text per sub-provision per deal) ───
let MAE_PROVISIONS=[
  {id:"p1",dealId:"d1",category:"Base Definition",text:'"Company Material Adverse Effect" means any change, effect, event, occurrence, state of facts or development that, individually or in the aggregate, has had or would reasonably be expected to have a material adverse effect on the business, financial condition, assets, liabilities or results of operations of the Company and its Subsidiaries, taken as a whole; provided, however, that none of the following shall be deemed to constitute, and none of the following shall be taken into account in determining whether there has been, a Company Material Adverse Effect:',favorability:"neutral"},
  {id:"p2",dealId:"d1",category:"General Economic / Market Conditions",text:'changes in general economic or political conditions or the financial, credit, debt, securities or other capital markets, in each case, in the United States or elsewhere in the world, including changes in interest rates, exchange rates and price of any security or market index',favorability:"mod-seller"},
  {id:"p3",dealId:"d1",category:"Changes in Law / GAAP",text:'any changes in applicable Law or GAAP (or authoritative interpretations thereof) or changes in regulatory accounting requirements applicable to the industries in which the Company operates, in each case, after the date of this Agreement',favorability:"neutral"},
  {id:"p4",dealId:"d1",category:"Industry Conditions",text:'changes in conditions generally affecting the industries in which the Company or any of its Subsidiaries operates',favorability:"mod-seller"},
  {id:"p5",dealId:"d1",category:"War / Terrorism",text:'acts of war (whether or not declared), armed hostilities, sabotage, terrorism, or any escalation or worsening thereof',favorability:"neutral"},
  {id:"p6",dealId:"d1",category:"Acts of God / Pandemic",text:'earthquakes, floods, hurricanes, tsunamis, tornadoes, wildfires or other natural disasters, weather conditions, pandemic, epidemic or disease outbreak (including COVID-19 or any COVID-19 Measures) or other force majeure events',favorability:"mod-seller"},
  {id:"p7",dealId:"d1",category:"Failure to Meet Projections",text:'any failure by the Company to meet any projections, forecasts or estimates of revenue, earnings or other financial performance or results of operations (it being understood that the facts or occurrences giving rise to or contributing to such failure that are not otherwise excluded from the definition of Company Material Adverse Effect may be taken into account)',favorability:"neutral"},
  {id:"p8",dealId:"d1",category:"Announcement / Pendency Effects",text:'the announcement or pendency of the Merger or the other transactions contemplated hereby, including the impact thereof on relationships with customers, suppliers, distributors, partners, employees, Governmental Authorities or others having business dealings with the Company',favorability:"mod-seller"},
  {id:"p9",dealId:"d1",category:"Actions at Parent Request",text:'any action taken or omitted to be taken at the express written request or with the prior written consent of Parent or as expressly required by this Agreement',favorability:"mod-seller"},
  {id:"p10",dealId:"d1",category:"Disproportionate Impact Qualifier",text:'except, in the case of clauses (a) through (f) above, to the extent that the Company and its Subsidiaries, taken as a whole, are disproportionately affected thereby relative to other participants in the industries in which the Company and its Subsidiaries operate (in which case, only the incremental disproportionate impact may be taken into account)',favorability:"neutral"},

  {id:"p11",dealId:"d3",category:"Base Definition",text:'"Company Material Adverse Effect" means any change, effect, event, occurrence, state of facts or development that, individually or in the aggregate, has had or would reasonably be expected to have a material adverse effect on the business, results of operations or financial condition of the Company and its Subsidiaries, taken as a whole; provided, however, that none of the following (or the results thereof) shall be deemed to constitute, and none of the following (or the results thereof) shall be taken into account in determining whether there has been, a Company Material Adverse Effect:',favorability:"neutral"},
  {id:"p12",dealId:"d3",category:"General Economic / Market Conditions",text:'changes in general economic conditions or the financial or securities markets generally (including changes in interest rates or exchange rates)',favorability:"neutral"},
  {id:"p13",dealId:"d3",category:"Changes in Law / GAAP",text:'changes in applicable Law or GAAP (or authoritative interpretation thereof) after the date hereof',favorability:"mod-buyer"},
  {id:"p14",dealId:"d3",category:"Industry Conditions",text:'changes in conditions generally affecting the pharmaceutical or biotechnology industries',favorability:"neutral"},
  {id:"p15",dealId:"d3",category:"War / Terrorism",text:'acts of war (whether or not declared), armed hostilities, sabotage, terrorism, or any escalation or worsening thereof',favorability:"neutral"},
  {id:"p16",dealId:"d3",category:"Acts of God / Pandemic",text:'earthquakes, floods, hurricanes, tsunamis, tornadoes, or other natural disasters, pandemic, epidemic or disease outbreak (including COVID-19 or any COVID-19 Measures), or other force majeure events',favorability:"mod-seller"},
  {id:"p17",dealId:"d3",category:"Failure to Meet Projections",text:'the failure of the Company to meet any internal or published projections, forecasts or estimates of revenue, earnings or other financial performance or results of operations for any period (it being understood that the underlying causes of such failure may be considered in determining whether a Company Material Adverse Effect has occurred to the extent not otherwise excluded hereby)',favorability:"neutral"},
  {id:"p18",dealId:"d3",category:"Announcement / Pendency Effects",text:'any effects arising from the announcement, pendency, or anticipated consummation of the Merger, including the impact thereof on relationships, contractual or otherwise, with customers, suppliers, distributors, partners, employees, or Governmental Authorities, or the identity of Parent or its Affiliates',favorability:"mod-seller"},
  {id:"p19",dealId:"d3",category:"Actions at Parent Request",text:'any action taken or omitted to be taken by the Company at the written request or with the prior written consent of Parent or as expressly required by this Agreement or the transactions contemplated hereby',favorability:"mod-seller"},
  {id:"p20",dealId:"d3",category:"Disproportionate Impact Qualifier",text:'except, in the case of clauses (a) through (f) above, to the extent such changes have a disproportionate adverse effect on the Company and its Subsidiaries, taken as a whole, relative to other similarly situated companies in the pharmaceutical and biotechnology industries (in which case only the incremental disproportionate impact may be taken into account)',favorability:"neutral"},

  {id:"p21",dealId:"d2",category:"Base Definition",text:'"Company Material Adverse Effect" means any change, effect, event, occurrence, state of facts or development that, individually or in the aggregate, has had or would reasonably be expected to have a material adverse effect on the business, financial condition, assets or results of operations of the Company and its Subsidiaries, taken as a whole; provided, however, that in no event shall any of the following, alone or in combination, be deemed to constitute, or be taken into account in determining whether there has been or would reasonably be expected to be, a Company Material Adverse Effect:',favorability:"neutral"},
  {id:"p22",dealId:"d2",category:"General Economic / Market Conditions",text:'changes in general economic, regulatory or political conditions or the financial, credit or securities markets generally, including changes in interest rates or exchange rates',favorability:"neutral"},
  {id:"p23",dealId:"d2",category:"Changes in Law / GAAP",text:'changes in Law or GAAP (or interpretation thereof) after the date hereof',favorability:"mod-buyer"},
  {id:"p24",dealId:"d2",category:"Industry Conditions",text:'changes in conditions generally affecting the interactive entertainment industry',favorability:"neutral"},
  {id:"p25",dealId:"d2",category:"War / Terrorism",text:'acts of war (whether or not declared), sabotage, terrorism, or any escalation or worsening thereof, or the outbreak or escalation of hostilities',favorability:"neutral"},
  {id:"p26",dealId:"d2",category:"Acts of God / Pandemic",text:'any earthquake, hurricane, tsunami, tornado, flood, mudslide, wildfire, or other natural disaster, epidemic, pandemic or disease outbreak (including COVID-19 or any COVID-19 Measures), or any other force majeure event',favorability:"mod-seller"},
  {id:"p27",dealId:"d2",category:"Failure to Meet Projections",text:'any failure by the Company to meet any internal or published projections, estimates or forecasts of revenue, earnings or other financial performance or results of operations for any period (provided that the underlying facts and circumstances giving rise to such failure may be taken into account in determining whether a Company Material Adverse Effect has occurred to the extent not otherwise excluded)',favorability:"neutral"},
  {id:"p28",dealId:"d2",category:"Announcement / Pendency Effects",text:'the announcement, pendency or consummation of the transactions contemplated by this Agreement, including the impact thereof on relationships, contractual or otherwise, with customers, suppliers, partners, licensors, licensees, distributors, employees or Governmental Authorities, or the identity of Parent or its Affiliates',favorability:"strong-seller"},
  {id:"p29",dealId:"d2",category:"Actions at Parent Request",text:'any action taken or omitted to be taken by the Company at the express written request or with the prior written consent of Parent or as expressly required by this Agreement or the transactions contemplated hereby',favorability:"mod-seller"},
  {id:"p30",dealId:"d2",category:"Disproportionate Impact Qualifier",text:'except, in the case of clauses (a) through (f) above, to the extent that such change disproportionately adversely affects the Company and its Subsidiaries, taken as a whole, relative to other participants in the industries in which the Company and its Subsidiaries operate (in which case only the incremental disproportionate impact may be taken into account)',favorability:"neutral"},
  {id:"p31",dealId:"d2",category:"Changes in Stock Price",text:'any decline in the market price or trading volume of Company Common Stock (provided that the underlying facts and circumstances giving rise to or contributing to such decline may be taken into account in determining whether a Company Material Adverse Effect has occurred to the extent not otherwise excluded)',favorability:"mod-seller"},
];

// ─── IOC PROVISIONS (structured: prohibition + exceptions) ───
let IOC_PROVISIONS=[
  // Broadcom/VMware
  {id:"i1",dealId:"d1",category:"M&A / Acquisitions",prohibition:"shall not acquire or agree to acquire, by merging or consolidating with, by purchasing an equity interest in or a material portion of the assets of, or by any other manner, any business or any corporation, partnership, association or other business organization or division thereof, or otherwise acquire or agree to acquire any assets",exceptions:[{label:"De minimis threshold",text:"acquisitions with a value not in excess of $100,000,000 individually or $250,000,000 in the aggregate"}],favorability:"mod-buyer"},
  {id:"i2",dealId:"d1",category:"Dividends / Distributions",prohibition:"shall not declare, set aside, make or pay any dividends or other distributions, whether payable in cash, stock, property or otherwise, with respect to any of its capital stock",exceptions:[{label:"Regular quarterly dividends",text:"regular quarterly cash dividends not exceeding $0.46 per share consistent with the existing dividend policy"},{label:"Subsidiary dividends",text:"dividends by a direct or indirect wholly owned Subsidiary to its parent"}],favorability:"neutral"},
  {id:"i3",dealId:"d1",category:"Equity Issuances",prohibition:"shall not issue, sell, pledge, dispose of, grant, transfer, encumber, or authorize the issuance, sale, pledge, disposition, grant, transfer or encumbrance of, any shares of capital stock or securities convertible or exchangeable into or exercisable for any shares of such capital stock",exceptions:[{label:"Existing equity awards",text:"issuance upon exercise of outstanding Company Options or settlement of Company RSUs"},{label:"ESPP",text:"issuances under the Company ESPP in the ordinary course"}],favorability:"mod-buyer"},
  {id:"i4",dealId:"d1",category:"Indebtedness",prohibition:"shall not incur any indebtedness for borrowed money or issue any debt securities or assume, guarantee or endorse the obligations of any Person for borrowed money",exceptions:[{label:"Aggregate cap",text:"indebtedness not in excess of $500,000,000 in the aggregate"},{label:"Existing facilities",text:"borrowings under existing credit facilities in the ordinary course"},{label:"Intercompany",text:"intercompany indebtedness"},{label:"Letters of credit",text:"letters of credit in the ordinary course"}],favorability:"neutral"},
  {id:"i5",dealId:"d1",category:"Capital Expenditures",prohibition:"shall not make or commit to make capital expenditures",exceptions:[{label:"Budget variance",text:"expenditures not in excess of 110% of the amount set forth in the Company capital expenditure budget provided to Parent"}],favorability:"mod-buyer"},
  {id:"i6",dealId:"d1",category:"Employee Compensation",prohibition:"shall not (i) increase compensation or benefits of any current or former director, officer or employee; (ii) grant any equity or equity-based awards; or (iii) adopt, enter into, materially amend or terminate any Company Benefit Plan",exceptions:[{label:"Ordinary course non-officers",text:"increases in the ordinary course consistent with past practice for non-officer employees"},{label:"Legal requirements",text:"as required by applicable Law"},{label:"Existing plans",text:"as required by any existing Company Benefit Plan"},{label:"OC equity grants",text:"equity grants in the ordinary course consistent with past practice"}],favorability:"mod-buyer"},

  // Pfizer/Seagen
  {id:"i10",dealId:"d3",category:"M&A / Acquisitions",prohibition:"shall not acquire or agree to acquire, by merging or consolidating with, by purchasing an equity interest in or a portion of the assets of, or by any other manner, any business or any Person or division thereof, or otherwise acquire or agree to acquire any assets",exceptions:[{label:"OC asset purchases",text:"acquisitions of assets (other than equity interests) in the ordinary course of business not exceeding $50,000,000 individually or $150,000,000 in the aggregate"}],favorability:"mod-buyer"},
  {id:"i11",dealId:"d3",category:"Dividends / Distributions",prohibition:"shall not declare, set aside, make or pay any dividends or distributions",exceptions:[{label:"Regular quarterly dividends",text:"regular quarterly cash dividends consistent with past practice not exceeding the per-share amount of the most recent quarterly dividend"},{label:"Subsidiary dividends",text:"dividends by wholly owned Subsidiaries to their parent"}],favorability:"neutral"},
  {id:"i12",dealId:"d3",category:"Equity Issuances",prohibition:"shall not issue, sell, grant, pledge or otherwise encumber any shares of capital stock or securities convertible or exchangeable therefor",exceptions:[{label:"Existing awards",text:"upon the exercise or settlement of Company equity awards outstanding on the date hereof"},{label:"ESPP",text:"under the ESPP consistent with past practice"},{label:"Tax withholding",text:"in connection with tax withholding obligations arising from settlement of equity awards"}],favorability:"neutral"},
  {id:"i13",dealId:"d3",category:"Indebtedness",prohibition:"shall not incur, assume, guarantee or otherwise become liable for any indebtedness for borrowed money",exceptions:[{label:"Existing facilities",text:"borrowings under existing credit facilities in the ordinary course not to exceed $100,000,000"},{label:"Intercompany",text:"intercompany indebtedness among the Company and its wholly owned Subsidiaries"},{label:"Letters of credit",text:"letters of credit in the ordinary course"}],favorability:"mod-buyer"},
  {id:"i14",dealId:"d3",category:"Capital Expenditures",prohibition:"shall not make or commit to make capital expenditures",exceptions:[{label:"Budget/OC",text:"in the ordinary course consistent with existing plans and budget"},{label:"Over-budget allowance",text:"any individual expenditure not in excess of $25,000,000 or aggregate expenditures not in excess of $75,000,000 in excess of such budget"}],favorability:"mod-buyer"},
  {id:"i15",dealId:"d3",category:"Employee Compensation",prohibition:"shall not (i) increase compensation; (ii) grant any equity awards; or (iii) adopt or materially amend any Company Benefit Plan",exceptions:[{label:"Annual merit (capped)",text:"annual merit increases in the ordinary course not exceeding 5% for non-officer employees"},{label:"Legal/existing plans",text:"as required by applicable Law or existing plans"},{label:"New hires below VP",text:"new hires below VP level at compensation consistent with past practice"}],favorability:"mod-buyer"},

  // Microsoft/Activision
  {id:"i20",dealId:"d2",category:"M&A / Acquisitions",prohibition:"shall not acquire or agree to acquire, by merging or consolidating with, by purchasing an equity interest in or a material portion of the assets of, or by any other manner, any business or any Person or division thereof",exceptions:[{label:"OC asset purchases",text:"purchases of assets in the ordinary course not exceeding $50,000,000 individually"},{label:"Intercompany",text:"transactions solely between the Company and wholly owned Subsidiaries or solely between wholly owned Subsidiaries"}],favorability:"mod-buyer"},
  {id:"i21",dealId:"d2",category:"Dividends / Distributions",prohibition:"shall not declare, set aside, make or pay any dividend or other distribution with respect to any capital stock",exceptions:[{label:"Regular quarterly dividends",text:"regular quarterly cash dividends not exceeding $0.47 per share consistent with existing dividend policy"},{label:"Subsidiary dividends",text:"dividends by a direct or indirect wholly owned Subsidiary to its parent"}],favorability:"neutral"},
  {id:"i22",dealId:"d2",category:"Equity Issuances",prohibition:"shall not issue, sell, grant, pledge, dispose of or encumber any shares of capital stock or securities convertible or exercisable therefor",exceptions:[{label:"Existing awards",text:"pursuant to outstanding Company equity awards"},{label:"ESPP",text:"under the ESPP consistent with past practice"},{label:"Tax withholding",text:"in connection with tax withholding obligations"}],favorability:"neutral"},
  {id:"i23",dealId:"d2",category:"Indebtedness",prohibition:"shall not incur any indebtedness for borrowed money or issue any debt securities or assume, guarantee or endorse the obligations of any Person",exceptions:[{label:"Existing facilities",text:"borrowings under existing credit facilities in the ordinary course not exceeding $100,000,000"},{label:"Intercompany",text:"intercompany indebtedness in the ordinary course"},{label:"Letters of credit / bonds",text:"letters of credit, performance bonds or surety bonds in the ordinary course"}],favorability:"neutral"},
  {id:"i24",dealId:"d2",category:"Capital Expenditures",prohibition:"shall not make or commit to make capital expenditures",exceptions:[{label:"Disclosure schedule + variance",text:"amounts set forth in the Company Disclosure Letter for the applicable period (plus a 10% variance)"}],favorability:"mod-buyer"},
  {id:"i25",dealId:"d2",category:"Employee Compensation",prohibition:"shall not (i) increase compensation or benefits; (ii) grant equity awards; or (iii) adopt, enter into, materially amend or terminate any material Company Benefit Plan",exceptions:[{label:"OC non-officers",text:"in the ordinary course consistent with past practice for non-director/officer employees"},{label:"Legal requirements",text:"as required by applicable Law"},{label:"Existing plans",text:"as required by existing Company Benefit Plans"},{label:"Annual equity grants",text:"annual grants in the ordinary course consistent with past practice"}],favorability:"mod-buyer"},
];

// Full provision texts for coverage calculation (admin feature)
const FULL_TEXTS={
  MAE:{d1:{charCount:2800},d2:{charCount:3100},d3:{charCount:2650}},
  IOC:{d1:{charCount:3400},d2:{charCount:3200},d3:{charCount:2900}}
};

let goldStandards=JSON.parse(localStorage.getItem("goldStandards")||"[]");
function saveGold(){localStorage.setItem("goldStandards",JSON.stringify(goldStandards))}
let favOverrides=JSON.parse(localStorage.getItem("favOverrides")||"{}");
function saveFav(){localStorage.setItem("favOverrides",JSON.stringify(favOverrides))}
function getProvFav(pid){return favOverrides[pid]||(MAE_PROVISIONS.find(p=>p.id===pid)||IOC_PROVISIONS.find(p=>p.id===pid))?.favorability||"unrated"}

// ═══════════════════════════════════════
// STATE
// ═══════════════════════════════════════
let state={provisionType:null,selectedDeals:["d1","d2","d3"],searchTerms:[],adminMode:false,compareResults:null,activeTab:"coded",askHistory:[],collapsed:{},sectionCollapsed:{}};

// ═══════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════
const esc=s=>s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):"";
const getDeal=id=>DEALS.find(d=>d.id===id);
const dealLabel=d=>`${d.acquirer} / ${d.target}`;
function highlightText(t,terms){if(!terms||!terms.length)return esc(t);const rx=new RegExp(`(${terms.map(t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")})`,"gi");return esc(t).replace(rx,'<span class="hl">$1</span>')}
function getCatsForType(t){return SUB_PROVISIONS[t]||[]}

// Dollar annotation: parse $X,XXX,XXX or $XB/$XM and show as % of deal value
function annotateDollars(html, dealId){
  const deal=getDeal(dealId);if(!deal||!deal.valueNum)return html;
  return html.replace(/\$([0-9,]+(?:\.[0-9]+)?)\s*(billion|million|B|M)?/gi,(match,num,unit)=>{
    let val=parseFloat(num.replace(/,/g,""));
    if(!val)return match;
    const u=(unit||"").toLowerCase();
    if(u==="billion"||u==="b")val*=1e9;
    else if(u==="million"||u==="m")val*=1e6;
    else if(val>=1e6)val=val; // raw number like 100,000,000
    else return match; // too small to be meaningful
    const pct=(val/deal.valueNum*100);
    if(pct<0.001||pct>100)return match;
    const pctStr=pct<1?pct.toFixed(2):pct.toFixed(1);
    return `${match} <span class="pct-ann">(${pctStr}% of deal)</span>`;
  });
}

// Coverage: % of full text characters covered by coded extracts (admin only)
function getTextCoverage(type, dealId){
  const ft=FULL_TEXTS[type]?.[dealId];if(!ft)return null;
  let codedChars=0;
  if(type==="MAE"){codedChars=MAE_PROVISIONS.filter(p=>p.dealId===dealId).reduce((s,p)=>s+p.text.length,0)}
  else{codedChars=IOC_PROVISIONS.filter(p=>p.dealId===dealId).reduce((s,p)=>s+p.prohibition.length+p.exceptions.reduce((x,e)=>x+e.text.length,0),0)}
  const pct=Math.min(100,Math.round(codedChars/ft.charCount*100));
  return{pct,coded:codedChars,total:ft.charCount};
}

// Collapse helpers
function isCollapsed(key){return !!state.collapsed[key]}
function toggleCollapse(key){state.collapsed[key]=!state.collapsed[key];renderContent()}
function isSectionCollapsed(key){return !!state.sectionCollapsed[key]}
function toggleSection(key){state.sectionCollapsed[key]=!state.sectionCollapsed[key];renderContent()}

// ═══════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════
function onInput(){const q=document.getElementById("q").value;document.getElementById("q-clear").style.display=q?"block":"none";state.searchTerms=q.toLowerCase().split(/\s+/).filter(t=>t.length>2);renderSidebar()}
function clearQ(){document.getElementById("q").value="";document.getElementById("q-clear").style.display="none";state.searchTerms=[];renderSidebar()}
async function doSearch(){const q=document.getElementById("q").value.trim();if(!q)return;const btn=document.getElementById("search-go");btn.disabled=true;btn.textContent="...";try{const r=await fetch("/api/search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:q,deals:DEALS,provisions:MAE_PROVISIONS.concat(IOC_PROVISIONS)})});const d=await r.json();if(d.intent==="deal"){const ids=d.results.filter(r=>r.startsWith("DEAL:")).map(r=>r.replace("DEAL:",""));if(ids.length)state.selectedDeals=ids.slice(0,5)}if(d.terms)state.searchTerms=d.terms;renderSidebar();renderContent()}catch(e){console.error(e)}btn.disabled=false;btn.textContent="Search"}
function applyFilter(f){if(f.toUpperCase().includes("MAE"))selectProvisionType("MAE");else if(f.toUpperCase().includes("COVENANT")||f.toUpperCase().includes("IOC"))selectProvisionType("IOC")}

// ═══════════════════════════════════════
// SIDEBAR
// ═══════════════════════════════════════
function renderSidebar(){
  const el=document.getElementById("sidebar");
  let h=`<div class="sidebar-header">Provisions <span style="font-size:10px;color:var(--text5);text-transform:none;letter-spacing:0;cursor:pointer" onclick="selectProvisionType(null)">show all</span></div>`;
  h+=`<div class="prov-item ${state.provisionType===null?"selected":""}" onclick="selectProvisionType(null)"><div class="prov-type" style="color:var(--text3)">ALL</div><div class="prov-title">All Provisions</div></div>`;
  PROVISION_TYPES.forEach(pt=>{h+=`<div class="prov-item ${state.provisionType===pt.key?"selected":""}" onclick="selectProvisionType('${pt.key}')"><div class="prov-type">${pt.key}</div><div class="prov-title">${pt.label}</div><div class="prov-deal">${getCatsForType(pt.key).length} sub-provisions</div></div>`});
  h+=`<div class="sidebar-header">Deals <span style="font-size:10px;color:var(--gold);text-transform:none;letter-spacing:0">${state.selectedDeals.length}</span></div>`;
  DEALS.forEach(d=>{const ck=state.selectedDeals.includes(d.id);h+=`<div class="deal-item" onclick="toggleDeal('${d.id}')"><div class="deal-check ${ck?"checked":""}">&#10003;</div><div class="deal-info"><div class="deal-name">${esc(dealLabel(d))}</div><div class="deal-meta">${d.value} &middot; ${d.sector} &middot; ${d.date.slice(0,4)}</div><div class="deal-meta" style="font-size:9.5px">${esc((d.lawyers?.buyer||[]).concat(d.lawyers?.seller||[]).slice(0,2).join(", "))}</div></div></div>`});
  el.innerHTML=h;
}
function selectProvisionType(t){state.provisionType=t;state.compareResults=null;state.activeTab="coded";renderSidebar();renderContent()}
function toggleDeal(id){const i=state.selectedDeals.indexOf(id);if(i>=0)state.selectedDeals.splice(i,1);else state.selectedDeals.push(id);state.compareResults=null;renderSidebar();renderContent()}

// ═══════════════════════════════════════
// CONTENT
// ═══════════════════════════════════════
function renderContent(){
  const el=document.getElementById("content");
  if(!state.selectedDeals.length){el.innerHTML='<div class="empty"><h3>No deals selected</h3></div>';return}
  const deals=state.selectedDeals.map(getDeal).filter(Boolean);
  const types=state.provisionType?[state.provisionType]:["MAE","IOC"];
  const typeName=state.provisionType?PROVISION_TYPES.find(pt=>pt.key===state.provisionType).label:"All Provisions";

  let h=`<div class="content-header"><div class="provision-type-label">${state.provisionType||"COMPARISON"}</div><div class="content-title">${typeName} &mdash; ${deals.length} Deal Comparison</div><div class="content-subtitle">Sub-provisions shown side by side. IOCs show prohibition + exceptions.</div><div class="action-row">${!state.compareResults?`<button class="action-btn compare" onclick="runCompare()">&#9889; Summarize Differences</button>`:`<button class="action-btn" onclick="clearCompare()" style="border-color:var(--gold);color:var(--gold)">&#10005; Clear Summary</button>`}<button class="action-btn" onclick="setTab('report')">Report</button><button class="action-btn" onclick="setTab('redline')">Markup Draft</button></div><div class="view-tabs"><div class="view-tab ${state.activeTab==="coded"?"active":""}" onclick="setTab('coded')">Coded</div><div class="view-tab ${state.activeTab==="report"?"active":""}" onclick="setTab('report')">Report</div><div class="view-tab ${state.activeTab==="redline"?"active":""}" onclick="setTab('redline')">Redline</div></div></div>`;

  if(state.adminMode){h+=`<div class="admin-banner"><span>Admin &mdash; Recode, add categories, view text coverage</span><div style="display:flex;gap:6px">${types.map(t=>`<button onclick="openAddCategory('${t}')">+ ${t}</button>`).join("")}<button onclick="toggleAdmin()">Off</button></div></div>`}

  if(state.activeTab==="coded"){types.forEach(type=>{
    const secKey="sec_"+type;const secOpen=!isSectionCollapsed(secKey);
    if(types.length>1)h+=`<div class="prongs-section" style="padding-bottom:0"><div class="provision-section-divider" onclick="toggleSection('${secKey}')"><span><span class="collapse-arrow ${secOpen?"open":""}">&#9654;</span>${PROVISION_TYPES.find(pt=>pt.key===type)?.label||type}</span><span class="meta">${getCatsForType(type).length} sub-provisions</span></div></div>`;
    if(secOpen||types.length===1){
      if(state.adminMode)h+=renderAdminCoverage(deals,type);
      h+=type==="IOC"?renderIOCCodedView(deals):renderMAECodedView(deals);
    }
  })}
  else if(state.activeTab==="report"){h+=renderReportView(deals,types)}
  else if(state.activeTab==="redline"){h+=renderRedlineView(deals)}
  el.innerHTML=h;
}
function setTab(t){state.activeTab=t;renderContent()}
function clearCompare(){state.compareResults=null;renderContent()}

// ═══════════════════════════════════════
// ADMIN COVERAGE (text % covered)
// ═══════════════════════════════════════
function renderAdminCoverage(deals,type){
  let h=`<div style="padding:0 28px 12px;display:flex;gap:12px;flex-wrap:wrap">`;
  deals.forEach(d=>{const c=getTextCoverage(type,d.id);if(!c)return;const cls=c.pct>=90?"full":c.pct>=60?"partial":"low";
    h+=`<div style="flex:1;min-width:130px;padding:8px 12px;background:var(--yellow-bg);border:1px solid #FFE082;border-radius:6px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--yellow);margin-bottom:2px">${esc(d.acquirer)}/${esc(d.target)}</div><div style="font-size:11px;color:var(--text2)">Text coverage: ~${c.pct}%</div><div class="coverage-bar"><div class="coverage-fill ${cls}" style="width:${c.pct}%"></div></div></div>`});
  h+=`</div>`;return h;
}

// ═══════════════════════════════════════
// MAE CODED VIEW
// ═══════════════════════════════════════
function renderMAECodedView(deals){
  const cats=getCatsForType("MAE"),cols=deals.length;
  let h=`<div class="prongs-section">`;
  cats.forEach(cat=>{
    const key="mae_"+cat;const open=!isCollapsed(key);
    const entries=deals.map(d=>{const p=MAE_PROVISIONS.find(p=>p.dealId===d.id&&p.category===cat);return{deal:d,prov:p}});
    const present=entries.filter(e=>e.prov).length;
    let tc="all",tt=`${present}/${deals.length}`;if(present===0){tc="missing";tt="None"}else if(present===deals.length){tc="all";tt="All"}
    const cmp=state.compareResults?.comparisons?.find(c=>c.category===cat);

    h+=`<div class="prong-card"><div class="prong-header" onclick="toggleCollapse('${key}')"><div><span class="collapse-arrow ${open?"open":""}">&#9654;</span><span class="prong-name">${esc(cat)}</span></div><div style="display:flex;gap:8px;align-items:center"><span class="prong-tag ${tc}">${tt}</span>${state.adminMode?`<button class="admin-edit" onclick="event.stopPropagation();openRecode('${esc(cat)}','MAE')">Recode</button>`:""}</div></div>`;
    h+=`<div class="prong-body ${open?"":"collapsed"}" style="grid-template-columns:repeat(${cols},1fr)">`;
    entries.forEach(e=>{const fav=e.prov?getProvFav(e.prov.id):null;
      h+=`<div class="prong-cell"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><div class="prong-deal-label">${esc(e.deal.acquirer)}/${esc(e.deal.target)}</div>${e.prov?renderFavBadge(e.prov.id,fav):""}</div><div class="prong-text">${e.prov?annotateDollars(highlightText(e.prov.text,state.searchTerms),e.deal.id):'<span class="absent">Not present</span>'}</div></div>`});
    h+=`</div>`;
    if(cmp&&open)h+=`<div class="prong-analysis"><strong>${esc(cmp.summary)}</strong><br>${cmp.most_buyer_friendly?`Buyer: <strong>${esc(cmp.most_buyer_friendly)}</strong>. `:""}${cmp.most_seller_friendly?`Seller: <strong>${esc(cmp.most_seller_friendly)}</strong>. `:""}${cmp.market_position?`<span style="color:var(--gold);font-weight:600">Market: ${esc(cmp.market_position)}</span>`:""}</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;return h;
}

// ═══════════════════════════════════════
// IOC CODED VIEW (prohibition + exceptions)
// ═══════════════════════════════════════
function renderIOCCodedView(deals){
  const cats=getCatsForType("IOC"),cols=deals.length;
  let h=`<div class="prongs-section">`;
  cats.forEach(cat=>{
    const key="ioc_"+cat;const open=!isCollapsed(key);
    const entries=deals.map(d=>{const p=IOC_PROVISIONS.find(p=>p.dealId===d.id&&p.category===cat);return{deal:d,prov:p}});
    const present=entries.filter(e=>e.prov).length;
    let tc="all",tt=`${present}/${deals.length}`;if(present===0){tc="missing";tt="None"}else if(present===deals.length){tc="all";tt="All"}
    const cmp=state.compareResults?.comparisons?.find(c=>c.category===cat);

    h+=`<div class="prong-card"><div class="prong-header" onclick="toggleCollapse('${key}')"><div><span class="collapse-arrow ${open?"open":""}">&#9654;</span><span class="prong-name">${esc(cat)}</span></div><div style="display:flex;gap:8px;align-items:center"><span class="prong-tag ${tc}">${tt}</span>${state.adminMode?`<button class="admin-edit" onclick="event.stopPropagation()">Recode</button>`:""}</div></div>`;

    h+=`<div class="prong-body ${open?"":"collapsed"}" style="grid-template-columns:repeat(${cols},1fr)">`;
    entries.forEach(e=>{
      const fav=e.prov?getProvFav(e.prov.id):null;
      h+=`<div class="prong-cell"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><div class="prong-deal-label">${esc(e.deal.acquirer)}/${esc(e.deal.target)}</div>${e.prov?renderFavBadge(e.prov.id,fav):""}</div>`;
      if(e.prov){
        h+=`<div class="prong-text" style="font-weight:500;color:var(--text)">${annotateDollars(highlightText(e.prov.prohibition,state.searchTerms),e.deal.id)}</div>`;
        if(e.prov.exceptions.length){
          h+=`<div class="ioc-exception-section">`;
          e.prov.exceptions.forEach(ex=>{
            h+=`<div style="margin-bottom:6px"><div class="ioc-exception-label">${esc(ex.label)}</div><div class="ioc-exception-text">${annotateDollars(highlightText(ex.text,state.searchTerms),e.deal.id)}</div></div>`;
          });
          h+=`</div>`;
        }
      }else{h+=`<div class="prong-text"><span class="absent">Not present</span></div>`}
      h+=`</div>`;
    });
    h+=`</div>`;
    if(cmp&&open)h+=`<div class="prong-analysis"><strong>${esc(cmp.summary)}</strong></div>`;
    h+=`</div>`;
  });
  h+=`</div>`;return h;
}

// ═══════════════════════════════════════
// FAVORABILITY
// ═══════════════════════════════════════
function renderFavBadge(pid,fav){const lv=FAV_LEVELS.find(f=>f.key===fav);if(!lv)return`<span class="fav-badge unrated" onclick="event.stopPropagation();openFavPicker('${pid}',this)">Rate</span>`;return`<span class="fav-badge ${fav}" onclick="event.stopPropagation();openFavPicker('${pid}',this)">${lv.label}</span>`}
function openFavPicker(pid,el){const dd=document.getElementById("fav-dropdown");const r=el.getBoundingClientRect();dd.style.top=(r.bottom+4)+"px";dd.style.left=Math.min(r.left,window.innerWidth-180)+"px";dd.style.display="block";dd.innerHTML=FAV_LEVELS.map(f=>`<div class="fav-option" onclick="setFav('${pid}','${f.key}')"><div class="fav-dot" style="background:${f.color}"></div>${f.label}</div>`).join("")+`<div class="fav-option" onclick="setFav('${pid}','unrated')" style="color:var(--text4)">Clear</div>`;setTimeout(()=>{const cl=e=>{if(!dd.contains(e.target)){dd.style.display="none";document.removeEventListener("click",cl)}};document.addEventListener("click",cl)},10)}
function setFav(pid,lv){favOverrides[pid]=lv;saveFav();document.getElementById("fav-dropdown").style.display="none";renderContent()}

// ═══════════════════════════════════════
// REPORT VIEW
// ═══════════════════════════════════════
function renderReportView(deals,types){
  let h=`<div style="padding:20px 28px"><div style="font:700 20px var(--serif);margin-bottom:4px">Precedent Comparison Report</div><div style="font-size:11px;color:var(--text4);margin-bottom:20px">${new Date().toISOString().split("T")[0]} &mdash; ${deals.length} deals</div>`;
  // Deal overview
  h+=`<div style="font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text4);margin-bottom:8px">Deal Overview</div><table class="report-table"><thead><tr><th style="width:130px"></th>`;
  deals.forEach(d=>h+=`<th>${esc(d.acquirer)}/${esc(d.target)}</th>`);h+=`</tr></thead><tbody>`;
  [["Value",d=>d.value],["Date",d=>d.date],["Structure",d=>d.structure],["Buyer Counsel",d=>(d.lawyers?.buyer||[]).join(", ")],["Seller Counsel",d=>(d.lawyers?.seller||[]).join(", ")],["Buyer Advisors",d=>(d.advisors?.buyer||[]).join(", ")||"\u2014"],["Seller Advisors",d=>(d.advisors?.seller||[]).join(", ")],["Term. Fee",d=>d.termFee]].forEach(([l,fn])=>{h+=`<tr><td class="lbl">${l}</td>`;deals.forEach(d=>h+=`<td>${esc(fn(d)||"\u2014")}</td>`);h+=`</tr>`});
  h+=`</tbody></table>`;

  // MAE table
  if(types.includes("MAE")){
    h+=`<div style="font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--gold);margin:24px 0 8px;font-weight:700">Material Adverse Effect</div><table class="report-table"><thead><tr><th style="width:150px">Sub-Provision</th>`;
    deals.forEach(d=>h+=`<th>${esc(d.acquirer)}/${esc(d.target)}</th>`);h+=`</tr></thead><tbody>`;
    getCatsForType("MAE").forEach(cat=>{h+=`<tr><td class="lbl">${esc(cat)}</td>`;deals.forEach(d=>{const p=MAE_PROVISIONS.find(p=>p.dealId===d.id&&p.category===cat);h+=p?`<td>${esc(p.text)}</td>`:`<td style="color:var(--text5);font-style:italic">\u2014</td>`});h+=`</tr>`});
    h+=`</tbody></table>`;
  }
  // IOC table
  if(types.includes("IOC")){
    h+=`<div style="font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--gold);margin:24px 0 8px;font-weight:700">Interim Operating Covenants</div><table class="report-table"><thead><tr><th style="width:150px">Sub-Provision</th>`;
    deals.forEach(d=>h+=`<th>${esc(d.acquirer)}/${esc(d.target)}</th>`);h+=`</tr></thead><tbody>`;
    getCatsForType("IOC").forEach(cat=>{
      // Prohibition row
      h+=`<tr><td class="lbl">${esc(cat)}<br><span style="font-size:9px;color:var(--red);font-weight:400">Prohibition</span></td>`;
      deals.forEach(d=>{const p=IOC_PROVISIONS.find(p=>p.dealId===d.id&&p.category===cat);h+=p?`<td>${esc(p.prohibition)}</td>`:`<td style="color:var(--text5)">\u2014</td>`});h+=`</tr>`;
      // Exceptions row
      h+=`<tr><td class="lbl" style="padding-left:24px"><span style="font-size:9px;color:var(--blue);font-weight:600">Exceptions</span></td>`;
      deals.forEach(d=>{const p=IOC_PROVISIONS.find(p=>p.dealId===d.id&&p.category===cat);if(p&&p.exceptions.length){h+=`<td>${p.exceptions.map(e=>`<strong style="font-size:9px;color:var(--blue);font-family:var(--sans)">${esc(e.label)}:</strong> ${esc(e.text)}`).join("<br><br>")}</td>`}else h+=`<td style="color:var(--text5)">\u2014</td>`});h+=`</tr>`;
    });
    h+=`</tbody></table>`;
  }

  if(state.compareResults)h+=`<div style="padding:16px;background:var(--gold-light);border:1px solid var(--gold-border);border-radius:10px;margin:20px 0"><div style="font:600 14px var(--serif);margin-bottom:6px">AI Analysis</div><div style="font-size:13px;color:var(--text2);line-height:1.6">${esc(state.compareResults.overall_summary||"")}</div></div>`;
  else h+=`<div style="padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin:20px 0;font-size:12px;color:var(--text3)">Click "Summarize Differences" to add AI analysis.</div>`;
  h+=`</div>`;return h;
}

// ═══════════════════════════════════════
// REDLINE
// ═══════════════════════════════════════
function renderRedlineView(deals){const et=state.provisionType||"MAE";return`<div style="padding:20px 28px"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text4);margin-bottom:8px">Paste your draft provision</div><textarea class="redline-textarea" id="redline-draft" placeholder="Paste the draft ${et} provision here..."></textarea><div style="margin-top:12px"><button class="action-btn primary" onclick="runRedline()">Run Redline Analysis</button></div><div id="redline-results" style="margin-top:20px"></div></div>`}
async function runRedline(){const draft=document.getElementById("redline-draft")?.value?.trim();if(!draft)return;const deal=getDeal(state.selectedDeals[0]);if(!deal)return;const et=state.provisionType||"MAE";let ft="";if(et==="MAE")ft=MAE_PROVISIONS.filter(p=>p.dealId===deal.id).map(p=>p.text).join(" ");else ft=IOC_PROVISIONS.filter(p=>p.dealId===deal.id).map(p=>p.prohibition+" "+p.exceptions.map(e=>e.text).join(" ")).join(" ");const res=document.getElementById("redline-results");res.innerHTML='<div class="loading"><svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg> Analyzing...</div>';try{const r=await fetch("/api/redline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({precedentText:ft,draftText:draft,dealName:dealLabel(deal),provisionType:et})});const d=await r.json();let h=`<div style="padding:14px;border-radius:8px;margin-bottom:16px;background:${d.riskLevel==="high"?"var(--red-bg)":d.riskLevel==="medium"?"var(--yellow-bg)":"var(--green-bg)"}"><span class="risk-badge ${d.riskLevel}">${d.riskLevel} risk</span><p style="font-size:13px;color:var(--text2);line-height:1.6;margin-top:8px">${esc(d.summary)}</p></div>`;(d.differences||[]).forEach(x=>{h+=`<div class="diff-card"><div style="display:flex;justify-content:space-between"><strong>${esc(x.category)}</strong><span class="risk-badge ${x.risk}">${x.risk}</span></div><div class="diff-cols"><div class="diff-col"><label>Precedent</label><p>${esc(x.precedent_language)}</p></div><div class="diff-col"><label>Draft</label><p>${esc(x.draft_language)}</p></div></div><div style="font-size:12px;color:var(--text2);line-height:1.5;margin:6px 0">${esc(x.analysis)}</div><div class="diff-rec"><strong>Rec:</strong> ${esc(x.recommendation)}</div></div>`});res.innerHTML=h}catch(e){res.innerHTML=`<div style="color:var(--red)">${e.message}</div>`}}

// ═══════════════════════════════════════
// COMPARE (AI SUMMARIZE)
// ═══════════════════════════════════════
async function runCompare(){
  const deals=state.selectedDeals.map(getDeal).filter(Boolean);const types=state.provisionType?[state.provisionType]:["MAE","IOC"];
  const allProngs=[];
  types.forEach(type=>{getCatsForType(type).forEach(cat=>{const entries=deals.map(d=>{
    let text="[NOT PRESENT]";
    if(type==="MAE"){const p=MAE_PROVISIONS.find(p=>p.dealId===d.id&&p.category===cat);if(p)text=p.text}
    else{const p=IOC_PROVISIONS.find(p=>p.dealId===d.id&&p.category===cat);if(p)text=p.prohibition+" Exceptions: "+p.exceptions.map(e=>e.text).join("; ")}
    return{dealId:d.id,text}});allProngs.push({category:cat,entries})})});
  state.compareResults={comparisons:[],overall_summary:"Analyzing...",key_takeaway:""};renderContent();
  try{const ptl=state.provisionType?PROVISION_TYPES.find(pt=>pt.key===state.provisionType).label:"All Provisions";const r=await fetch("/api/compare",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provisionType:ptl,prongs:allProngs,deals})});state.compareResults=await r.json()}catch(e){state.compareResults={overall_summary:"Error: "+e.message,comparisons:[]}}renderContent();
}

// ═══════════════════════════════════════
// ADMIN
// ═══════════════════════════════════════
function toggleAdmin(){state.adminMode=!state.adminMode;document.getElementById("admin-btn").classList.toggle("active",state.adminMode);renderContent()}
function openAddCategory(type){const modal=document.getElementById("add-cat-modal");const body=document.getElementById("add-cat-body");const cats=getCatsForType(type);body.innerHTML=`<div style="font-size:12px;color:var(--text3);margin-bottom:14px">New sub-provision under <strong>${type}</strong></div><div class="recode-field"><label>Category Name</label><input type="text" id="new-cat-name" placeholder="e.g. Government Contracts"></div><div style="display:flex;gap:8px;margin-top:16px"><button class="save-btn" onclick="saveNewCategory('${type}')">Add</button><button class="action-btn" onclick="document.getElementById('add-cat-modal').style.display='none'">Cancel</button></div><div style="margin-top:16px;font-size:11px;color:var(--text3)"><strong>Current:</strong><br>${cats.map((c,i)=>`${i+1}. ${esc(c)}`).join("<br>")}</div>`;modal.style.display="flex";setTimeout(()=>document.getElementById("new-cat-name").focus(),100)}
function saveNewCategory(type){const nm=document.getElementById("new-cat-name")?.value?.trim();if(!nm)return;if(getCatsForType(type).includes(nm)){alert("Exists.");return}SUB_PROVISIONS[type].push(nm);saveCats();document.getElementById("add-cat-modal").style.display="none";renderContent()}
function openRecode(cat,type){const modal=document.getElementById("recode-modal");const body=document.getElementById("recode-body");const cats=getCatsForType(type);const deals=state.selectedDeals.map(getDeal).filter(Boolean);let h=`<div class="recode-field"><label>Category</label><select id="recode-cat">${cats.map(c=>`<option ${c===cat?"selected":""}>${esc(c)}</option>`).join("")}</select></div>`;deals.forEach(d=>{const p=MAE_PROVISIONS.find(p=>p.dealId===d.id&&p.category===cat);h+=`<div class="recode-field"><label>${esc(dealLabel(d))}</label><textarea id="recode-${d.id}">${p?esc(p.text):""}</textarea></div>`});h+=`<div style="display:flex;gap:8px;margin-top:16px"><button class="save-btn" onclick="saveRecode('${esc(cat)}','${type}')">Save Gold Standard</button><button class="action-btn" onclick="document.getElementById('recode-modal').style.display='none'">Cancel</button></div><div style="margin-top:12px;font-size:11px;color:var(--text3)">Ensure the <strong>entire</strong> provision text is captured.</div>`;body.innerHTML=h;modal.style.display="flex"}
function saveRecode(origCat,type){const newCat=document.getElementById("recode-cat").value;state.selectedDeals.map(getDeal).filter(Boolean).forEach(d=>{const ta=document.getElementById(`recode-${d.id}`);if(!ta)return;const nt=ta.value.trim();const ex=MAE_PROVISIONS.findIndex(p=>p.dealId===d.id&&p.category===origCat);if(ex>=0){MAE_PROVISIONS[ex].category=newCat;MAE_PROVISIONS[ex].text=nt;MAE_PROVISIONS[ex].isGold=true}else if(nt){MAE_PROVISIONS.push({id:`p_${Date.now()}_${d.id}`,dealId:d.id,category:newCat,text:nt,isGold:true,favorability:"unrated"})}goldStandards.push({dealId:d.id,type,category:newCat,text:nt,correctedAt:new Date().toISOString()})});saveGold();document.getElementById("recode-modal").style.display="none";state.compareResults=null;renderContent()}

// ═══════════════════════════════════════
// ASK
// ═══════════════════════════════════════
function toggleAsk(){document.getElementById("ask-panel").classList.toggle("open");document.getElementById("ask-btn").classList.toggle("active")}
async function sendAsk(){const input=document.getElementById("ask-q");const q=input.value.trim();if(!q)return;input.value="";const msgs=document.getElementById("ask-msgs");msgs.innerHTML+=`<div class="ask-msg user"><div class="bubble">${esc(q)}</div></div>`;msgs.innerHTML+=`<div class="ask-msg assistant" id="ask-load"><div class="bubble"><svg class="spinner" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg></div></div>`;msgs.scrollTop=msgs.scrollHeight;document.getElementById("ask-go").disabled=true;const ctx=MAE_PROVISIONS.map(p=>{const d=getDeal(p.dealId);return`[MAE/${p.category}] ${d?dealLabel(d):p.dealId}: ${p.text}`}).concat(IOC_PROVISIONS.map(p=>{const d=getDeal(p.dealId);return`[IOC/${p.category}] ${d?dealLabel(d):p.dealId}: Prohibition: ${p.prohibition} Exceptions: ${p.exceptions.map(e=>e.label+": "+e.text).join("; ")}`})).join("\n\n");state.askHistory.push({role:"user",content:q});try{const r=await fetch("/api/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:q,context:ctx,history:state.askHistory.slice(-10)})});const d=await r.json();document.getElementById("ask-load")?.remove();const ans=d.answer||d.error||"No response";state.askHistory.push({role:"assistant",content:ans});msgs.innerHTML+=`<div class="ask-msg assistant"><div class="bubble">${ans.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>")}</div></div>`}catch(e){document.getElementById("ask-load")?.remove();msgs.innerHTML+=`<div class="ask-msg assistant"><div class="bubble" style="color:var(--red)">${e.message}</div></div>`}msgs.scrollTop=msgs.scrollHeight;document.getElementById("ask-go").disabled=false}

renderSidebar();renderContent();

// ═══════════════════════════════════════
// AUTO-UPDATE (polls for new deployments)
// ═══════════════════════════════════════
(function(){
  let currentVersion=null;
  async function checkVersion(){
    try{
      const r=await fetch('/api/version',{cache:'no-store'});
      const d=await r.json();
      if(!currentVersion){currentVersion=d.version;return}
      if(d.version!==currentVersion){
        const toast=document.createElement('div');
        toast.style.cssText='position:fixed;bottom:20px;right:20px;background:#1a1a1a;color:#fff;padding:12px 20px;border-radius:8px;font:500 13px var(--sans);z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,0.2);display:flex;align-items:center;gap:10px;animation:fadeIn 0.3s';
        toast.innerHTML='<span style="color:var(--gold)">&#9889;</span> New version detected. Refreshing...';
        document.body.appendChild(toast);
        setTimeout(()=>location.reload(),1500);
      }
    }catch(e){}
  }
  checkVersion();
  setInterval(checkVersion,30000);
})();
</script>
</body>
</html>
